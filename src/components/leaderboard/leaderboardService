// src/LeaderboardService.js
import db from './firebase';
import { collection, query, orderBy, getDocs, limit } from "firebase/firestore";

export const IsUsernameExist = async (username) => {
  const querySnapshot = await getDocs(query(collection(db, "leaderboard"), where("username", "==", username)));
  return querySnapshot.size > 0;
}

export const AddUserInLeaderboard = async (username, score) => {
  try {
    const isUsernameExist = await IsUsernameExist(username);
    if (isUsernameExist) {
      const querySnapshot = await getDocs(query(collection(db, "leaderboard"), where("username", "==", username)));
      querySnapshot.forEach(async (doc) => {
        await updateDoc(doc.ref, { score: score });
      });
    } else {
      await addDoc(collection(db, "leaderboard"), {
        username: username,
        score: score
      });
    }
    return true;
  } catch (e) {
    console.error("Error adding/updating leaderboard: ", e);
    return false;
  }
}

export const GetLeaderboard = async () => {
  const querySnapshot = await getDocs(query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10)));
  return querySnapshot.docs.map((doc, index) => ({
    id: doc.id,
    username: doc.data().username,
    score: doc.data().score,
    rank: index + 1
  }));
}
